---
// src/components/Navbar.astro
import { t } from "../i18n/index.js";

// Obtener el idioma inicial del localStorage o usar español por defecto
const initialLang =
    typeof window !== "undefined"
        ? localStorage.getItem("preferredLang") || "es"
        : "es";

import LanguageSelector from "./LanguageSelector.astro";
---

<nav
    class="fixed top-0 left-0 w-full bg-black/90 backdrop-blur-md text-white shadow-lg z-50 transition-all duration-300"
    role="navigation"
    aria-label="Navegación principal"
    id="main-navbar"
>
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <!-- Logo -->
        <a
            href="#hero"
            class="text-2xl font-bold text-[#E64530] hover:text-[#e66f5f] transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded"
            aria-label="Ir al inicio"
            data-i18n="navbar.home"
        >
            {t(initialLang, "navbar.home")}
        </a>

        <!-- Menú principal -->
        <div class="hidden md:flex space-x-8 text-lg" role="menubar">
            <!-- About -->
            <a
                href="/#about"
                class="hover:text-[#E64530] transition-colors duration-200 py-2 relative after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-[#E64530] after:transition-all after:duration-300 hover:after:w-full focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded px-2"
                role="menuitem"
                data-i18n="navbar.about"
            >
                {t(initialLang, "navbar.about")}
            </a>
            <!-- Skills -->
            <a
                href="/#skills"
                class="hover:text-[#E64530] transition-colors duration-200 py-2 relative after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-[#E64530] after:transition-all after:duration-300 hover:after:w-full focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded px-2"
                role="menuitem"
                data-i18n="navbar.skills"
            >
                {t(initialLang, "navbar.skills")}
            </a>
            <!-- Projects -->
            <a
                href="/#projects"
                class="hover:text-[#E64530] transition-colors duration-200 py-2 relative after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-[#E64530] after:transition-all after:duration-300 hover:after:w-full focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded px-2"
                role="menuitem"
                data-i18n="navbar.projects"
            >
                {t(initialLang, "navbar.projects")}
            </a>
            <!-- Contact -->
            <a
                href="/#contact"
                class="hover:text-[#E64530] transition-colors duration-200 py-2 relative after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-[#E64530] after:transition-all after:duration-300 hover:after:w-full focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded px-2"
                role="menuitem"
                data-i18n="navbar.contact"
            >
                {t(initialLang, "navbar.contact")}
            </a>
        </div>

        <!-- Selector de idioma -->
        <LanguageSelector currentLang={initialLang} />

        <!-- Botón menú móvil -->
        <button
            id="menuBtn"
            class="md:hidden flex flex-col space-y-1.5 focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded p-1 transition-transform duration-300"
            aria-label="Abrir menú de navegación"
            aria-expanded="false"
            aria-controls="mobileMenu"
        >
            <span
                class="w-6 h-0.5 bg-white transition-all duration-300 transform"
            ></span>
            <span class="w-6 h-0.5 bg-white transition-all duration-300"></span>
            <span
                class="w-6 h-0.5 bg-white transition-all duration-300 transform"
            ></span>
        </button>
    </div>

    <!-- Menú móvil -->
    <div
        id="mobileMenu"
        class="hidden flex-col md:hidden bg-black/95 backdrop-blur-md border-t border-[#E64530] text-center space-y-4 py-4 transition-all duration-300 transform -translate-y-2 opacity-0"
        role="menu"
        aria-labelledby="menuBtn"
    >
        <a
            href="/#about"
            class="hover:text-[#E64530] transition-colors duration-200 py-2 focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded mx-4"
            role="menuitem"
            tabindex="-1"
            data-i18n="navbar.about"
        >
            {t(initialLang, "navbar.about")}
        </a>
        <a
            href="/#skills"
            class="hover:text-[#E64530] transition-colors duration-200 py-2 focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded mx-4"
            role="menuitem"
            tabindex="-1"
            data-i18n="navbar.skills"
        >
            {t(initialLang, "navbar.skills")}
        </a>
        <a
            href="/#projects"
            class="hover:text-[#E64530] transition-colors duration-200 py-2 focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded mx-4"
            role="menuitem"
            tabindex="-1"
            data-i18n="navbar.projects"
        >
            {t(initialLang, "navbar.projects")}
        </a>
        <a
            href="/#contact"
            class="hover:text-[#E64530] transition-colors duration-200 py-2 focus:outline-none focus:ring-2 focus:ring-[#E64530] focus:ring-opacity-50 rounded mx-4"
            role="menuitem"
            tabindex="-1"
            data-i18n="navbar.contact"
        >
            {t(initialLang, "navbar.contact")}
        </a>
    </div>

    <!-- Script mejorado con internacionalización -->
    <script>
        // Sistema de traducciones
        const translations = {
            es: {
                "navbar.home": "Inicio",
                "navbar.about": "Acerca de",
                "navbar.skills": "Habilidades",
                "navbar.projects": "Proyectos",
                "navbar.contact": "Contacto",
            },
            en: {
                "navbar.home": "Home",
                "navbar.about": "About",
                "navbar.skills": "Skills",
                "navbar.projects": "Projects",
                "navbar.contact": "Contact",
            },
            zh: {
                "navbar.home": "首页",
                "navbar.about": "关于",
                "navbar.skills": "技能",
                "navbar.projects": "项目",
                "navbar.contact": "联系",
            },
        };

        const ariaLabels = {
            es: {
                menu: "Abrir menú de navegación",
                lang: "Seleccionar idioma",
            },
            en: {
                menu: "Open navigation menu",
                lang: "Select language",
            },
            zh: {
                menu: "打开导航菜单",
                lang: "选择语言",
            },
        };

        // Elementos del DOM
        const menuBtn = document.getElementById("menuBtn");
        const mobileMenu = document.getElementById("mobileMenu");
        const menuSpans = menuBtn.querySelectorAll("span");
        let isMenuOpen = false;
        let currentLang = localStorage.getItem("preferredLang") || "es";

        // Función para actualizar todos los textos de la navbar
        function updateNavbarTexts(lang) {
            const elements = document.querySelectorAll("[data-i18n]");
            elements.forEach((element) => {
                const key = element.getAttribute("data-i18n");
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Actualizar atributos ARIA
            if (ariaLabels[lang]) {
                menuBtn.setAttribute("aria-label", ariaLabels[lang].menu);
            }
        }

        // Función para cambiar idioma
        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem("preferredLang", lang);
            document.documentElement.lang = lang;

            // Actualizar todos los textos de la navbar
            updateNavbarTexts(lang);

            console.log(`Idioma cambiado a: ${lang}`);
        }

        // Función para abrir/cerrar menú móvil
        function toggleMobileMenu() {
            isMenuOpen = !isMenuOpen;

            if (isMenuOpen) {
                mobileMenu.classList.remove("hidden");
                mobileMenu.offsetHeight;
                mobileMenu.classList.remove("opacity-0", "-translate-y-2");
                mobileMenu.classList.add("opacity-100", "translate-y-0");

                menuSpans[0].classList.add("rotate-45", "translate-y-2");
                menuSpans[1].classList.add("opacity-0");
                menuSpans[2].classList.add("-rotate-45", "-translate-y-2");

                menuBtn.setAttribute("aria-expanded", "true");

                const mobileMenuItems = mobileMenu.querySelectorAll("a");
                mobileMenuItems.forEach((item) => {
                    item.setAttribute("tabindex", "0");
                });

                if (mobileMenuItems.length > 0) {
                    mobileMenuItems[0].focus();
                }
            } else {
                mobileMenu.classList.remove("opacity-100", "translate-y-0");
                mobileMenu.classList.add("opacity-0", "-translate-y-2");

                menuSpans[0].classList.remove("rotate-45", "translate-y-2");
                menuSpans[1].classList.remove("opacity-0");
                menuSpans[2].classList.remove("-rotate-45", "-translate-y-2");

                menuBtn.setAttribute("aria-expanded", "false");

                const mobileMenuItems = mobileMenu.querySelectorAll("a");
                mobileMenuItems.forEach((item) => {
                    item.setAttribute("tabindex", "-1");
                });

                setTimeout(() => {
                    if (!isMenuOpen) {
                        mobileMenu.classList.add("hidden");
                    }
                }, 300);
            }
        }

        // Cerrar menú al hacer clic fuera
        document.addEventListener("click", (e) => {
            if (
                isMenuOpen &&
                !mobileMenu.contains(e.target) &&
                !menuBtn.contains(e.target)
            ) {
                toggleMobileMenu();
            }
        });

        // Cerrar menú con tecla Escape
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && isMenuOpen) {
                toggleMobileMenu();
                menuBtn.focus();
            }
        });

        // Inicializar con el idioma actual
        document.documentElement.lang = currentLang;

        // Event listeners
        menuBtn.addEventListener("click", toggleMobileMenu);

        // Cerrar menú móvil al hacer clic en un enlace
        const mobileMenuLinks = mobileMenu.querySelectorAll("a");
        mobileMenuLinks.forEach((link) => {
            link.addEventListener("click", () => {
                if (isMenuOpen) {
                    toggleMobileMenu();
                }
            });
        });

        // Escuchar cambios de idioma desde el LanguageSelector
        window.addEventListener("languageChanged", (e) => {
            changeLanguage(e.detail.language);
        });

        // Inicializar textos cuando se carga la página
        document.addEventListener("DOMContentLoaded", () => {
            updateNavbarTexts(currentLang);
        });
    </script>
</nav>

<style>
    @media (max-width: 768px) {
        nav {
            padding: 0 1rem;
        }
    }

    html {
        scroll-behavior: smooth;
    }
</style>
